<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sushi Merge: Points Update</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #fce8cc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            width: 100vw;
            touch-action: none;
        }

        /* --- ОБЩИЕ СТИЛИ МЕНЮ --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(252, 232, 204, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.5s;
        }

        .menu-content {
            background: white;
            padding: 30px 20px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(93, 64, 55, 0.2);
            width: 85%;
            max-width: 360px;
            border: 4px solid #5d4037;
            box-sizing: border-box;
        }

        .menu-title {
            font-size: 26px;
            color: #5d4037;
            margin-bottom: 5px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .menu-subtitle {
            font-size: 16px;
            color: #ee5253;
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* Список наград */
        .rewards-list {
            text-align: left;
            background: #fff5e6;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            list-style: none;
            border: 2px dashed #ffb8b8;
        }

        .rewards-list li {
            margin-bottom: 10px;
            font-size: 14px;
            color: #5d4037;
            display: flex;
            align-items: center;
        }

        .rewards-list li:last-child { margin-bottom: 0; }
        
        .badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 4px 8px; /* Чуть увеличил отступы */
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
            min-width: 80px; /* Увеличил ширину под текст */
            text-align: center;
            white-space: nowrap;
        }

        /* Кнопки */
        .btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 0 #c0392b;
            transition: transform 0.1s;
            text-transform: uppercase;
        }

        .btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        /* Окно результатов */
        #result-text {
            font-size: 15px;
            color: #5d4037;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .promo-box {
            background: #2d3436;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 24px;
            margin: 10px 0 20px 0;
            letter-spacing: 2px;
            border: 2px solid #fab1a0;
        }

        /* --- ИГРОВОЙ ИНТЕРФЕЙС --- */
        #ui-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 400px;
            margin-top: 10px;
            margin-bottom: 5px;
            z-index: 100;
        }

        .score-box {
            background: #fff;
            padding: 8px 15px;
            border-radius: 12px;
            border: 2px solid #5d4037;
            font-weight: bold;
            font-size: 18px;
            color: #5d4037;
            min-width: 100px;
        }

        .next-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #5d4037;
            font-size: 12px;
            font-weight: bold;
        }

        #game-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            background: #ebd5b3;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #bcaaa4;
            border-right: 5px solid #bcaaa4;
            border-bottom: 5px solid #bcaaa4;
            transform-origin: top center; 
        }

        #danger-line {
            position: absolute;
            top: 130px;
            left: 0;
            width: 100%;
            height: 2px;
            border-top: 2px dashed rgba(231, 76, 60, 0.6);
            pointer-events: none;
            z-index: 10;
        }
        
        #danger-text {
            position: absolute;
            top: 110px;
            right: 5px;
            font-size: 10px;
            color: rgba(231, 76, 60, 0.8);
            pointer-events: none;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

    <!-- СТАРТОВОЕ МЕНЮ -->
    <div id="start-menu" class="overlay">
        <div class="menu-content">
            <div class="menu-title">Sushi Merge</div>
            <div class="menu-subtitle">Играй и получай<br>бесплатные роллы!</div>
            
            <ul class="rewards-list">
                <!-- ДОБАВЛЕНО СЛОВО "ОЧКОВ" -->
                <li><span class="badge">1000 очков</span> Маки с лососем</li>
                <li><span class="badge">2000 очков</span> Темпура с крабом</li>
                <li><span class="badge">3000 очков</span> Филадельфия лайт</li>
            </ul>

            <button class="btn" onclick="startGame()">НАЧАТЬ</button>
        </div>
    </div>

    <!-- МЕНЮ GAME OVER -->
    <div id="game-over-menu" class="overlay" style="display: none;">
        <div class="menu-content">
            <div class="menu-title">Игра окончена!</div>
            <div class="menu-subtitle">Ваш счет: <span id="final-score">0</span></div>
            
            <div id="result-text">Текст результата</div>
            <div id="promo-container" style="display:none;">
                <div class="promo-box" id="promo-code">CODE</div>
                <div style="font-size: 10px; color: #888;">Покажите промокод официанту или введите на сайте</div>
            </div>

            <button class="btn" style="margin-top:20px; background-color: #2e86de; box-shadow: 0 5px 0 #1e6cb3;" onclick="restartGame()">ИГРАТЬ ЕЩЕ</button>
        </div>
    </div>

    <!-- ИГРА -->
    <div id="ui-header">
        <div class="score-box">Очки: <span id="score">0</span></div>
        <div class="next-box">
            <span>Next</span>
            <canvas id="next-canvas" width="50" height="50"></canvas>
        </div>
    </div>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="danger-line"></div>
            <span id="danger-text">Линия переполнения</span>
        </div>
    </div>

<script>
    // --- ПЕРЕМЕННЫЕ СОСТОЯНИЯ ---
    let gameActive = false;
    let gameOver = false;
    let score = 0;
    
    // --- НАСТРОЙКИ ---
    const LOGICAL_WIDTH = 340; 
    const LOGICAL_HEIGHT = 650;
    const WALL_THICKNESS = 60;
    const DANGER_Y = 130; 

    // --- ФУНКЦИИ ИНТЕРФЕЙСА ---

    function startGame() {
        const menu = document.getElementById('start-menu');
        menu.style.opacity = '0';
        setTimeout(() => {
            menu.style.display = 'none';
            gameActive = true;
            gameOver = false;
            resizeGame();
            spawnCurrent();
        }, 500);
    }

    function restartGame() {
        Composite.clear(world, false, true); 
        createWalls();
        score = 0;
        document.getElementById('score').innerText = '0';
        gameActive = true;
        gameOver = false;
        currentBody = null;
        canDrop = true;
        document.getElementById('game-over-menu').style.display = 'none';
        nextSushiIndex = getRandomSushiIndex();
        updateNextPreview();
        spawnCurrent();
    }

    function showGameOver() {
        gameActive = false;
        gameOver = true;
        const menu = document.getElementById('game-over-menu');
        const finalText = document.getElementById('result-text');
        const promoContainer = document.getElementById('promo-container');
        const promoCode = document.getElementById('promo-code');
        const finalScoreEl = document.getElementById('final-score');
        finalScoreEl.innerText = score;
        menu.style.display = 'flex';
        menu.style.opacity = '1';

        if (score >= 3000) {
            finalText.innerText = "Поздравляю с победой! Твой промокод на ролл Филадельфия лайт к заказу от 1000₽:";
            promoCode.innerText = "ФИЛА";
            promoContainer.style.display = 'block';
        } else if (score >= 2000) {
            finalText.innerText = "Поздравляю с победой! Твой промокод на ролл Темпура с крабом к заказу от 1300₽:";
            promoCode.innerText = "КРАБ";
            promoContainer.style.display = 'block';
        } else if (score >= 1000) {
            finalText.innerText = "Поздравляю с победой! Твой промокод на ролл Маки с лососем к заказу от 1500₽:";
            promoCode.innerText = "МАКИ";
            promoContainer.style.display = 'block';
        } else {
            finalText.innerText = "Немного не хватило до приза! Набери 1000 очков, чтобы получить бесплатный ролл.";
            promoContainer.style.display = 'none';
        }
    }

    // --- MATTER.JS SETUP ---
    const SUSHI_TYPES = [
        { radius: 23, type: 'maki', color: '#ff6b6b' }, 
        { radius: 32, type: 'maki', color: '#9aca3c' }, 
        { radius: 45, type: 'rice', color: '#ff9f43' }, 
        { radius: 58, type: 'rice', color: '#f368e0' }, 
        { radius: 72, type: 'rice', color: '#ee5253' }, 
        { radius: 86, type: 'rice', color: '#2e86de' },        
        { radius: 98, type: 'rice', color: '#10ac84' },        
        { radius: 115, type: 'special', color: '#222f3e' }     
    ];

    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events,
          World = Matter.World,
          Body = Matter.Body;

    const engine = Engine.create();
    const world = engine.world;

    const containerElement = document.getElementById('game-container');
    const render = Render.create({
        element: containerElement,
        engine: engine,
        options: {
            width: LOGICAL_WIDTH,
            height: LOGICAL_HEIGHT,
            wireframes: false,
            background: 'transparent'
        }
    });

    function createWalls() {
        const wallOptions = { 
            isStatic: true, 
            render: { visible: false },
            restitution: 0.5,
            friction: 0
        };
        const ground = Bodies.rectangle(LOGICAL_WIDTH/2, LOGICAL_HEIGHT + WALL_THICKNESS/2, LOGICAL_WIDTH + 200, WALL_THICKNESS, wallOptions);
        const leftWall = Bodies.rectangle(0 - WALL_THICKNESS/2, LOGICAL_HEIGHT/2, WALL_THICKNESS, LOGICAL_HEIGHT * 2, wallOptions);
        const rightWall = Bodies.rectangle(LOGICAL_WIDTH + WALL_THICKNESS/2, LOGICAL_HEIGHT/2, WALL_THICKNESS, LOGICAL_HEIGHT * 2, wallOptions);
        World.add(world, [ground, leftWall, rightWall]);
    }
    createWalls();

    // --- ИГРОВАЯ ЛОГИКА ---
    let currentBody = null;
    let nextSushiIndex = 0;
    let canDrop = true;
    const spawnY = 60; 

    function createSushiBody(x, y, index, isStatic = false) {
        const type = SUSHI_TYPES[index];
        const body = Bodies.circle(x, y, type.radius, {
            label: index.toString(),
            isStatic: isStatic,
            restitution: 0.35, 
            friction: 0.02, 
            frictionAir: 0.001,  
            frictionStatic: 0.1, 
            density: 0.002,
            render: { fillStyle: 'transparent' }
        });
        body.sushiType = type; 
        return body;
    }

    function getRandomSushiIndex() { return Math.floor(Math.random() * 3); }

    function updateNextPreview() {
        const canvas = document.getElementById('next-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const type = SUSHI_TYPES[nextSushiIndex];
        drawSushiArt(ctx, 25, 25, 20, type);
    }

    function spawnCurrent() {
        if(gameOver) return;
        
        const typeIdx = nextSushiIndex;
        nextSushiIndex = getRandomSushiIndex();
        updateNextPreview();
        
        currentBody = createSushiBody(LOGICAL_WIDTH / 2, spawnY, typeIdx, true);
        currentBody.collisionFilter.group = -1; 
        World.add(world, currentBody);
        canDrop = true;
    }

    // --- СТРОГАЯ ПРОВЕРКА ПРОИГРЫША ---
    Events.on(engine, 'beforeUpdate', function() {
        if (!gameActive || gameOver) return;

        const bodies = Composite.allBodies(world);

        for (let i = 0; i < bodies.length; i++) {
            const body = bodies[i];
            
            // Игнорируем стены и шарик, который сейчас в руке
            if (body.isStatic || body === currentBody) continue;

            // Проверяем только шарики, которые относительно "спокойны" (speed < 0.5)
            // Это нужно, чтобы не засчитывать пролетающий мимо при сбросе шарик
            if (body.speed < 0.5) { 
                const radius = body.circleRadius;
                const diameter = radius * 2;
                
                // Верхний край шарика
                const topEdge = body.position.y - radius;
                
                // Насколько сильно шарик залез выше линии
                // DANGER_Y = 130. Если topEdge = 100, то overlap = 30.
                const overlap = DANGER_Y - topEdge;

                // Условие: если перекрытие больше чем 10% от диаметра
                const limit = diameter * 0.1;

                if (overlap > limit) {
                    showGameOver();
                    return; // Прерываем цикл, игра окончена
                }
            }
        }
    });

    // --- ОТРИСОВКА ---
    function drawSushiArt(ctx, x, y, radius, typeData) {
        if (typeData.type === 'maki') {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = '#2d3436'; 
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, y, radius * 0.85, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff'; 
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, y, radius * 0.45, 0, Math.PI * 2);
            ctx.fillStyle = typeData.color; 
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = '#fdfdfd'; 
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x, y, radius * 0.65, 0, Math.PI * 2);
            ctx.fillStyle = '#2d3436'; 
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, y, radius * 0.45, 0, Math.PI * 2);
            ctx.fillStyle = typeData.color; 
            ctx.fill();
        }
        ctx.beginPath();
        ctx.arc(x - radius*0.3, y - radius*0.3, radius*0.15, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.fill();
    }

    Events.on(render, 'afterRender', function() {
        const ctx = render.context;
        const bodies = Composite.allBodies(world);
        bodies.forEach(body => {
            if (body.sushiType) {
                drawSushiArt(ctx, body.position.x, body.position.y, body.circleRadius, body.sushiType);
            }
        });
    });

    // --- УПРАВЛЕНИЕ ---
    let scaleFactor = 1;
    function resizeGame() {
        const wrapper = document.getElementById('game-wrapper');
        const availableWidth = wrapper.clientWidth;
        const availableHeight = wrapper.clientHeight;
        const scaleX = availableWidth / LOGICAL_WIDTH;
        const scaleY = availableHeight / LOGICAL_HEIGHT;
        scaleFactor = Math.min(scaleX, scaleY);
        if (scaleFactor > 1.2) scaleFactor = 1.2;
        containerElement.style.transform = `scale(${scaleFactor})`;
    }
    window.addEventListener('resize', resizeGame);
    resizeGame();

    function handleInputMove(clientX) {
        if (!gameActive || !canDrop || !currentBody) return;
        const rect = containerElement.getBoundingClientRect();
        let x = (clientX - rect.left) / scaleFactor;
        const r = currentBody.circleRadius;
        if (x < r + 5) x = r + 5;
        if (x > LOGICAL_WIDTH - r - 5) x = LOGICAL_WIDTH - r - 5;
        Body.setPosition(currentBody, { x: x, y: spawnY });
    }

    function handleInputEnd() {
        if (!gameActive || !canDrop || !currentBody) return;
        canDrop = false;
        Body.setStatic(currentBody, false);
        currentBody.collisionFilter.group = 0; 
        currentBody = null;
        setTimeout(spawnCurrent, 800);
    }

    document.addEventListener('mousemove', (e) => handleInputMove(e.clientX));
    document.addEventListener('mouseup', handleInputEnd);
    containerElement.addEventListener('touchstart', (e) => {
        if(e.touches.length > 0) handleInputMove(e.touches[0].clientX);
    }, {passive: false});
    containerElement.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if(e.touches.length > 0) handleInputMove(e.touches[0].clientX);
    }, {passive: false});
    containerElement.addEventListener('touchend', handleInputEnd);

    // --- СЛИЯНИЕ ---
    Events.on(engine, 'collisionStart', (event) => {
        const pairs = event.pairs;
        for (let i = 0; i < pairs.length; i++) {
            const bodyA = pairs[i].bodyA;
            const bodyB = pairs[i].bodyB;
            if (bodyA.label === bodyB.label && bodyA.sushiType && bodyB.sushiType) {
                const index = parseInt(bodyA.label);
                if (index < SUSHI_TYPES.length - 1) {
                    World.remove(world, [bodyA, bodyB]);
                    const midX = (bodyA.position.x + bodyB.position.x) / 2;
                    const midY = (bodyA.position.y + bodyB.position.y) / 2;
                    const newBody = createSushiBody(midX, midY, index + 1);
                    World.add(world, newBody);
                    score += (index + 1) * 10;
                    document.getElementById('score').innerText = score;
                }
            }
        }
    });

    nextSushiIndex = getRandomSushiIndex();
    updateNextPreview();
    
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

</script>
</body>
</html>
